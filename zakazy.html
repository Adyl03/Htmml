<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система заказов - Almazbek</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .section {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .phone-input {
            display: flex;
            gap: 5px;
        }
        
        .phone-code {
            width: 80px;
        }
        
        .whatsapp-link {
            margin-left: 10px;
            color: #25D366;
            font-size: 24px;
            cursor: pointer;
            display: none;
        }
        
        .whatsapp-link.show {
            display: inline-block;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #764ba2;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .product-card {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .product-card.selected {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .order-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .order-item.selected {
            background: #d4edda;
        }
        
        .orders-list {
            display: grid;
            gap: 15px;
        }
        
        .order-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        #map {
            height: 300px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-upload-label {
            display: block;
            padding: 10px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .file-upload:hover .file-upload-label {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .quantity-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .quantity-inputs input {
            width: 80px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shopping-cart"></i> Система заказов</h1>
            <p>Агент: Алмазбек</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('new-order')">
                <i class="fas fa-plus"></i> Новый заказ
            </button>
            <button class="nav-tab" onclick="switchTab('orders')">
                <i class="fas fa-list"></i> Список заказов
            </button>
            <button class="nav-tab" onclick="switchTab('catalog')">
                <i class="fas fa-box"></i> Каталог
            </button>
            <button class="nav-tab" onclick="switchTab('reports')">
                <i class="fas fa-chart-bar"></i> Отчеты
            </button>
            <button class="nav-tab" onclick="switchTab('map')">
                <i class="fas fa-map"></i> Карта
            </button>
        </div>

        <!-- Новый заказ -->
        <div id="new-order" class="section active">
            <h2>Новый заказ</h2>
            
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Поиск по магазину, телефону или имени клиента..." id="globalSearch">
            </div>

            <div class="form-group">
                <label>Название магазина</label>
                <input type="text" id="shopName" placeholder="Введите название магазина">
            </div>

            <div class="form-group">
                <label>Локация магазина</label>
                <button class="btn" onclick="getCurrentLocation()">
                    <i class="fas fa-map-marker-alt"></i> Использовать текущую локацию
                </button>
                <div id="map" style="display: none;"></div>
                <input type="hidden" id="shopLocation">
            </div>

            <div class="form-group">
                <label>Фото магазина</label>
                <div class="file-upload">
                    <input type="file" id="shopPhoto" accept="image/*" onchange="previewImage(this, 'shopPhotoPreview')">
                    <label class="file-upload-label">
                        <i class="fas fa-camera"></i> Выберите фото
                    </label>
                </div>
                <img id="shopPhotoPreview" style="max-width: 200px; margin-top: 10px; display: none;">
            </div>

            <div class="form-group">
                <label>Имя клиента</label>
                <input type="text" id="clientName" placeholder="Введите имя клиента">
            </div>

            <div class="form-group">
                <label>Номер телефона</label>
                <div style="display: flex; align-items: center;">
                    <div class="phone-input">
                        <input type="text" class="phone-code" id="phoneCode" value="+996" placeholder="+996">
                        <input type="text" id="clientPhone" placeholder="700123456" oninput="updateWhatsappLink()">
                    </div>
                    <a id="whatsappLink" class="whatsapp-link" target="_blank">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                </div>
            </div>

            <button class="btn" onclick="saveClient()">
                <i class="fas fa-save"></i> Сохранить данные клиента
            </button>

            <div id="productsSection" style="display: none; margin-top: 30px;">
                <h3>Выбор товаров</h3>
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Поиск товаров..." id="productSearch">
                </div>
                <div class="product-grid" id="productsGrid"></div>

                <div class="order-summary">
                    <h4>Итого заказ</h4>
                    <div id="orderItems"></div>
                    <div style="margin-top: 15px;">
                        <strong>Общая сумма: <span id="totalAmount">0</span> сом</strong>
                    </div>
                    <div>
                        <strong>Количество товаров: <span id="totalItems">0</span></strong>
                    </div>
                    <button class="btn btn-success" onclick="saveOrder()">
                        <i class="fas fa-check"></i> Сохранить заказ
                    </button>
                </div>
            </div>
        </div>

        <!-- Список заказов -->
        <div id="orders" class="section">
            <h2>Список заказов за <span id="todayDate"></span></h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="todayOrdersCount">0</div>
                    <div class="stat-label">Заказов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayAmount">0</div>
                    <div class="stat-label">Общая сумма</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todaySalary">0</div>
                    <div class="stat-label">Зарплата</div>
                </div>
            </div>
            <div class="orders-list" id="ordersList"></div>
        </div>

        <!-- Каталог -->
        <div id="catalog" class="section">
            <h2>Каталог товаров</h2>
            <button class="btn" onclick="showAddProductModal()">
                <i class="fas fa-plus"></i> Добавить товар
            </button>
            <div class="product-grid" id="catalogGrid"></div>
        </div>

        <!-- Отчеты -->
        <div id="reports" class="section">
            <h2>Отчеты</h2>
            <div class="form-group">
                <label>Выберите период</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="reportStartDate">
                    <input type="date" id="reportEndDate">
                    <button class="btn" onclick="generateReport()">Показать</button>
                </div>
            </div>
            <div id="reportContent"></div>
            <button class="btn btn-success" onclick="downloadReport()" style="margin-top: 20px;">
                <i class="fas fa-download"></i> Скачать PDF отчет
            </button>
        </div>

        <!-- Карта -->
        <div id="map-section" class="section">
            <h2>Карта заказов</h2>
            <div class="form-group">
                <label>Выберите дату</label>
                <input type="date" id="mapDate" onchange="updateMap()">
            </div>
            <div id="mapView" style="height: 500px;"></div>
        </div>
    </div>

    <!-- Модальное окно для просмотра заказа -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Детали заказа</h3>
                <span class="close-btn" onclick="closeModal('orderModal')">&times;</span>
            </div>
            <div id="orderDetails"></div>
        </div>
    </div>

    <!-- Модальное окно для добавления/редактирования товара -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Добавить товар</h3>
                <span class="close-btn" onclick="closeModal('productModal')">&times;</span>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label>Фото товара</label>
                    <div class="file-upload">
                        <input type="file" id="productPhoto" accept="image/*" onchange="previewImage(this, 'productPhotoPreview')">
                        <label class="file-upload-label">
                            <i class="fas fa-camera"></i> Выберите фото
                        </label>
                    </div>
                    <img id="productPhotoPreview" style="max-width: 200px; margin-top: 10px; display: none;">
                </div>
                <div class="form-group">
                    <label>Название товара</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Цена за штуку</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Количество в упаковке (если есть)</label>
                    <input type="number" id="productPackQuantity" min="1">
                </div>
                <div class="form-group">
                    <label>Цена за упаковку</label>
                    <input type="number" id="productPackPrice" step="0.01">
                </div>
                <button type="submit" class="btn btn-success">Сохранить</button>
                <button type="button" class="btn btn-danger" onclick="deleteProduct()" id="deleteBtn" style="display: none;">
                    Удалить
                </button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Глобальные переменные
        let currentOrder = {
            client: null,
            items: [],
            total: 0
        };
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        let map, marker;
        let editingProductId = null;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadOrders();
            updateTodayStats();
            document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ru-RU');
            document.getElementById('reportStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('reportEndDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('mapDate').value = new Date().toISOString().split('T')[0];
            
            // Автосохранение каждые 3 секунды
            setInterval(autoSave, 3000);
        });

        // Функции вкладок
        function switchTab(tabName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'map') {
                setTimeout(() => initMap(), 100);
            }
        }

        // Работа с локацией
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    document.getElementById('shopLocation').value = `${lat},${lng}`;
                    showMap(lat, lng);
                });
            }
        }

        function showMap(lat, lng) {
            const mapDiv = document.getElementById('map');
            mapDiv.style.display = 'block';
            
            if (!map) {
                map = L.map('map').setView([lat, lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                
                map.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    document.getElementById('shopLocation').value = `${lat},${lng}`;
                    
                    if (marker) marker.remove();
                    marker = L.marker([lat, lng]).addTo(map);
                });
            } else {
                map.setView([lat, lng], 15);
            }
            
            if (marker) marker.remove();
            marker = L.marker([lat, lng]).addTo(map);
        }

        // WhatsApp ссылка
        function updateWhatsappLink() {
            const phone = document.getElementById('clientPhone').value;
            const code = document.getElementById('phoneCode').value;
            if (phone.length > 5) {
                const waLink = document.getElementById('whatsappLink');
                waLink.href = `https://wa.me/${code}${phone}`;
                waLink.classList.add('show');
            }
        }

        // Сохранение клиента
        function saveClient() {
            const shopName = document.getElementById('shopName').value;
            const clientName = document.getElementById('clientName').value;
            const clientPhone = document.getElementById('clientPhone').value;
            
            if (!shopName || !clientName || !clientPhone) {
                alert('Заполните обязательные поля!');
                return;
            }
            
            currentOrder.client = {
                shopName: shopName,
                shopLocation: document.getElementById('shopLocation').value,
                shopPhoto: document.getElementById('shopPhotoPreview').src || '',
                clientName: clientName,
                clientPhone: document.getElementById('phoneCode').value + clientPhone,
                date: new Date().toISOString()
            };
            
            document.getElementById('productsSection').style.display = 'block';
            loadProductsForOrder();
        }

        // Загрузка товаров для заказа
        function loadProductsForOrder() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.photo || 'https://via.placeholder.com/150'}" class="product-image">
                    <h4>${product.name}</h4>
                    <p>${product.price} сом/шт</p>
                    ${product.packQuantity ? `<p>${product.packPrice} сом/уп (${product.packQuantity} шт)</p>` : ''}
                `;
                card.onclick = () => selectProduct(product);
                grid.appendChild(card);
            });
        }

        // Выбор товара
        function selectProduct(product) {
            const existingItem = currentOrder.items.find(item => item.id === product.id);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                currentOrder.items.push({
                    ...product,
                    quantity: 1,
                    packQuantity: 0
                });
            }
            
            updateOrderSummary();
        }

        // Обновление итогов заказа
        function updateOrderSummary() {
            const container = document.getElementById('orderItems');
            container.innerHTML = '';
            
            let total = 0;
            let totalItems = 0;
            
            currentOrder.items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                
                let itemTotal = 0;
                if (item.packQuantity > 0) {
                    itemTotal = (item.packPrice * item.packQuantity) + (item.price * item.quantity);
                } else {
                    itemTotal = item.price * item.quantity;
                }
                
                total += itemTotal;
                totalItems += item.quantity;
                
                itemDiv.innerHTML = `
                    <div>
                        <strong>${item.name}</strong>
                        <div>
                            ${item.packQuantity > 0 ? `
                                <input type="number" value="${item.packQuantity}" min="0" 
                                    onchange="updateItemQuantity(${index}, 'pack', this.value)" style="width: 60px;">
                                <span>уп</span>
                            ` : ''}
                            <input type="number" value="${item.quantity}" min="1" 
                                onchange="updateItemQuantity(${index}, 'quantity', this.value)" style="width: 60px;">
                            <span>шт</span>
                        </div>
                    </div>
                    <div>
                        <strong>${itemTotal} сом</strong>
                        <button class="btn btn-danger" onclick="removeItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(itemDiv);
            });
            
            document.getElementById('totalAmount').textContent = total;
            document.getElementById('totalItems').textContent = totalItems;
            currentOrder.total = total;
        }

        function updateItemQuantity(index, type, value) {
            if (type === 'pack') {
                currentOrder.items[index].packQuantity = parseInt(value) || 0;
            } else {
                currentOrder.items[index].quantity = parseInt(value) || 1;
            }
            updateOrderSummary();
        }

        function removeItem(index) {
            currentOrder.items.splice(index, 1);
            updateOrderSummary();
        }

        // Сохранение заказа
        function saveOrder() {
            if (currentOrder.items.length === 0) {
                alert('Добавьте товары в заказ!');
                return;
            }
            
            const order = {
                ...currentOrder,
                id: Date.now(),
                date: new Date().toISOString().split('T')[0]
            };
            
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));
            
            alert('Заказ сохранен!');
            resetOrderForm();
            updateTodayStats();
        }

        function resetOrderForm() {
            currentOrder = { client: null, items: [], total: 0 };
            document.getElementById('productsSection').style.display = 'none';
            document.getElementById('orderItems').innerHTML = '';
            document.getElementById('totalAmount').textContent = '0';
            document.getElementById('totalItems').textContent = '0';
            
            // Очистить форму
            document.getElementById('shopName').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('shopLocation').value = '';
            document.getElementById('shopPhotoPreview').style.display = 'none';
            document.getElementById('whatsappLink').classList.remove('show');
        }

        // Загрузка списка заказов
        function loadOrders() {
            const container = document.getElementById('ordersList');
            container.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(order => order.date === today);
            
            todayOrders.forEach(order => {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <h4>${order.client.shopName}</h4>
                    <p><strong>Клиент:</strong> ${order.client.clientName}</p>
                    <p><strong>Телефон:</strong> ${order.client.clientPhone}</p>
                    <p><strong>Сумма:</strong> ${order.total} сом</p>
                    <p><strong>Товаров:</strong> ${order.items.length}</p>
                `;
                card.onclick = () => showOrderDetails(order);
                container.appendChild(card);
            });
        }

        function showOrderDetails(order) {
            const modal = document.getElementById('orderModal');
            const details = document.getElementById('orderDetails');
            
            details.innerHTML = `
                <p><strong>Магазин:</strong> ${order.client.shopName}</p>
                <p><strong>Клиент:</strong> ${order.client.clientName}</p>
                <p><strong>Телефон:</strong> ${order.client.clientPhone}</p>
                <p><strong>Дата:</strong> ${order.date}</p>
                ${order.client.shopLocation ? `<p><strong>Локация:</strong> ${order.client.shopLocation}</p>` : ''}
                <h4>Товары:</h4>
                <ul>
                    ${order.items.map(item => `
                        <li>${item.name} - ${item.quantity} шт 
                            ${item.packQuantity ? `(${item.packQuantity} уп)` : ''} - 
                            ${calculateItemTotal(item)} сом
                        </li>
                    `).join('')}
                </ul>
                <p><strong>Итого:</strong> ${order.total} сом</p>
            `;
            
            modal.style.display = 'block';
        }

        function calculateItemTotal(item) {
            let total = item.price * item.quantity;
            if (item.packQuantity > 0) {
                total += item.packPrice * item.packQuantity;
            }
            return total;
        }

        // Каталог товаров
        function loadProducts() {
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = '';
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.photo || 'https://via.placeholder.com/150'}" class="product-image">
                    <h4>${product.name}</h4>
                    <p>${product.price} сом/шт</p>
                    ${product.packQuantity ? `<p>${product.packPrice} сом/уп (${product.packQuantity} шт)</p>` : ''}
                    <button class="btn" onclick="editProduct(${product.id})">Редактировать</button>
                `;
                grid.appendChild(card);
            });
        }

        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Добавить товар';
            document.getElementById('productForm').reset();
            document.getElementById('productPhotoPreview').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            editingProductId = null;
            document.getElementById('productModal').style.display = 'block';
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('productModalTitle').textContent = 'Редактировать товар';
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productPackQuantity').value = product.packQuantity || '';
                document.getElementById('productPackPrice').value = product.packPrice || '';
                
                if (product.photo) {
                    document.getElementById('productPhotoPreview').src = product.photo;
                    document.getElementById('productPhotoPreview').style.display = 'block';
                }
                
                editingProductId = id;
                document.getElementById('deleteBtn').style.display = 'inline-block';
                document.getElementById('productModal').style.display = 'block';
            }
        }

        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const product = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                packQuantity: parseInt(document.getElementById('productPackQuantity').value) || null,
                packPrice: parseFloat(document.getElementById('productPackPrice').value) || null,
                photo: document.getElementById('productPhotoPreview').src || ''
            };
            
            if (editingProductId) {
                product.id = editingProductId;
                const index = products.findIndex(p => p.id === editingProductId);
                products[index] = product;
            } else {
                product.id = Date.now();
                products.push(product);
            }
            
            localStorage.setItem('products', JSON.stringify(products));
            loadProducts();
            closeModal('productModal');
        });

        function deleteProduct() {
            if (confirm('Удалить товар?')) {
                products = products.filter(p => p.id !== editingProductId);
                localStorage.setItem('products', JSON.stringify(products));
                loadProducts();
                closeModal('productModal');
            }
        }

        // Отчеты
        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            const filteredOrders = orders.filter(order => 
                order.date >= startDate && order.date <= endDate
            );
            
            let totalAmount = 0;
            let totalOrders = filteredOrders.length;
            let salary = 0;
            
            filteredOrders.forEach(order => {
                totalAmount += order.total;
            });
            
            const bonus = Math.floor(totalAmount / 10000) * 200;
            salary = (totalAmount * 0.1) + bonus;
            
            const container = document.getElementById('reportContent');
            container.innerHTML = `
                <h3>Отчет за период ${startDate} - ${endDate}</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${totalOrders}</div>
                        <div class="stat-label">Заказов</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalAmount}</div>
                        <div class="stat-label">Общая сумма</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${salary.toFixed(2)}</div>
                        <div class="stat-label">Зарплата</div>
                    </div>
                </div>
                <h4>Заказы:</h4>
                <ul>
                    ${filteredOrders.map(order => `
                        <li>${order.client.shopName} - ${order.client.clientName} - ${order.total} сом</li>
                    `).join('')}
                </ul>
            `;
        }

        function downloadReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            const filteredOrders = orders.filter(order => 
                order.date >= startDate && order.date <= endDate
            );
            
            let y = 20;
            
            doc.setFontSize(16);
            doc.text(`Отчет агента Алмазбек`, 20, y);
            y += 10;
            doc.setFontSize(12);
            doc.text(`Период: ${startDate} - ${endDate}`, 20, y);
            y += 20;
            
            let totalAmount = 0;
            filteredOrders.forEach(order => {
                totalAmount += order.total;
                doc.text(`${order.client.shopName} - ${order.client.clientName} - ${order.total} сом`, 20, y);
                y += 10;
            });
            
            const bonus = Math.floor(totalAmount / 10000) * 200;
            const salary = (totalAmount * 0.1) + bonus;
            
            y += 10;
            doc.text(`Итого: ${totalAmount} сом`, 20, y);
            y += 10;
            doc.text(`Зарплата: ${salary.toFixed(2)} сом (10% + ${bonus} сом бонус)`, 20, y);
            
            doc.save(`отчет-${startDate}-${endDate}.pdf`);
        }

        // Карта
        function initMap() {
            if (!map) {
                map = L.map('mapView').setView([42.87, 74.59], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            updateMap();
        }

        function updateMap() {
            const date = document.getElementById('mapDate').value;
            const dayOrders = orders.filter(order => order.date === date);
            
            // Очистить маркеры
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            dayOrders.forEach(order => {
                if (order.client.shopLocation) {
                    const [lat, lng] = order.client.shopLocation.split(',').map(Number);
                    L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(`
                            <strong>${order.client.shopName}</strong><br>
                            ${order.client.clientName}<br>
                            ${order.total} сом
                        `);
                }
            });
        }

        // Вспомогательные функции
        function previewImage(input, previewId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(previewId).style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function updateTodayStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(order => order.date === today);
            
            let totalAmount = 0;
            todayOrders.forEach(order => {
                totalAmount += order.total;
            });
            
            const bonus = Math.floor(totalAmount / 10000) * 200;
            const salary = (totalAmount * 0.1) + bonus;
            
            document.getElementById('todayOrdersCount').textContent = todayOrders.length;
            document.getElementById('todayAmount').textContent = totalAmount;
            document.getElementById('todaySalary').textContent = salary.toFixed(2);
        }

        function autoSave() {
            // Автоматическое сохранение уже реализовано через localStorage
            // Эта функция может быть использована для дополнительной логики
        }

        // Поиск
        document.getElementById('globalSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            // Поиск по сохраненным заказам для автозаполнения
            const matchedOrder = orders.find(order => 
                order.client.shopName.toLowerCase().includes(searchTerm) ||
                order.client.clientName.toLowerCase().includes(searchTerm) ||
                order.client.clientPhone.includes(searchTerm)
            );
            
            if (matchedOrder) {
                document.getElementById('shopName').value = matchedOrder.client.shopName;
                document.getElementById('clientName').value = matchedOrder.client.clientName;
                document.getElementById('clientPhone').value = matchedOrder.client.clientPhone.replace('+996', '');
                document.getElementById('phoneCode').value = '+996';
                updateWhatsappLink();
            }
        });

        document.getElementById('productSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('#productsGrid .product-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Закрытие модальных окон по клику вне
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
